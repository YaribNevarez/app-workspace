/*
 * systool.cpp
 *
 *  Created on: Aug 30, 2017
 *      Author: Yarib Nev√°rez (yarib_007@hotmail.com) - root
 */

#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <string.h>
#include <typeinfo>
#include "systool.hpp"
#include "framework/zybo.hpp"
#include "framework/commander.hpp"

SystemTool::SystemTool()
{
	tcpServerFeature = new TcpServerFeature(&ZYNQ_PMOD_HANDLER, 23);
}

SystemTool::TcpServerFeature::TcpServerFeature(DeviceHandler * device_handler, uint16_t host_port):
		SystemFeature(device_handler),
		server(host_port),
		flags(0x00)
{
}


bool SystemTool::TcpServerFeature::is_executing(void)
{
	return get_flag(EXECUTING);
}

bool SystemTool::TcpServerFeature::is_connected(void)
{
	return get_flag(CONNECTED);
}

void SystemTool::TcpServerFeature::set_flag(uint8_t flag)
{
	flags |= flag;
}

void SystemTool::TcpServerFeature::clear_flag(uint8_t flag)
{
	flags &= ~flag;
}

bool SystemTool::TcpServerFeature::get_flag(uint8_t flag)
{
	return flags & flag;
}

int SystemTool::TcpServerFeature::run(void)
{
	TcpSocket * client;

	server.prepare();

	client = server.accept_connection();

	if (client != NULL)
	{
		std::string message;
		std::string answer;

		do
		{
			//if (server.receive_buffer(message) > 0)
			{
				Commander::execute(message, answer);
				//server.send_buffer(answer);
			}
		} while(get_flag(EXECUTING));

		clear_flag(CONNECTED);
	}

	//return result;
}

int SystemTool::run(void)
{
	printf("Welcome to the local DevTool\n");

	for (;tcpServerFeature->isRunning(););

	printf("Bye\n");
    return 0;
}

SystemTool::~SystemTool()
{
}
